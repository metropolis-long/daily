<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.daily.dao.my.CostDao">
    <resultMap id="BaseResultMap" type="com.daily.dto.CostDTO">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="cost_id" jdbcType="BIGINT" property="costId"/>
        <result column="user_id" jdbcType="BIGINT" property="userId"/>
        <result column="cost_context" jdbcType="VARCHAR" property="costContext"/>
        <result column="cost_money" jdbcType="DECIMAL" property="costMoney"/>
        <result column="tag" jdbcType="VARCHAR" property="tag"/>
        <result column="created" jdbcType="TIMESTAMP" property="created"/>
        <result column="updated" jdbcType="TIMESTAMP" property="updated"/>
        <result column="avatar" jdbcType="VARCHAR" property="avatar" />
        <result column="nick_name" jdbcType="VARCHAR" property="nickName" />
    </resultMap>

    <select id="sumClassify4Cost" parameterType="com.daily.search.CostSearch" resultType="com.daily.dto.CostDTO">
        SELECT
        <include refid="cost_time_format"/>
        as 'timeStr',
        SUM(cost_money) as sumMoney
        FROM
        `cost`
        WHERE
        user_id =#{userId}
        GROUP BY
        <include refid="cost_time_format"/>
        WITH ROLLUP
    </select>
    <sql id="cost_time_format">
        <if test="timeType==1">
            date_format(created, '%Y')
        </if>
        <if test="timeType==2">
            date_format(created, '%Y-%m')
        </if>
    </sql>
    <select id="sumWeekCost" parameterType="com.daily.search.CostSearch" resultType="com.daily.dto.CostDTO">
        SELECT
        WEEK(date_add(c.created,interval 6 day),2) as sort,
            sum( c.cost_money ) AS sumMoney,
            date_format( created, '%Y-%m-%d' ) AS 'timeStr'
        FROM
            cost c
        WHERE
        <if test="thisYear !=null">
            date_format(created, '%Y')= date_format( #{thisYear}, '%Y' )
        </if>
        <if test="thisYear == null">
            date_format(created, '%Y')= date_format( now(), '%Y' )
        </if>
   and c.user_id =#{userId}
    GROUP BY sort
    WITH ROLLUP
  </select>
    <select id="findMyCost" parameterType="com.daily.search.CostSearch" resultMap="BaseResultMap">
        select * from cost as d
        <include refid="cost_sql"/>
        <if test="orderCause != null ">
            order by #{orderCause}
        </if>
        group by d.cost_id
        <if test="page != null">
            limit #{page.begin},#{page.length}
        </if>
    </select>
    <select id="count4FindMyCost" parameterType="com.daily.search.CostSearch" resultType="int">
        select count(*) from (
        select * from cost as d
        <include refid="cost_sql"/>
        group by d.cost_id
        )t
    </select>
    <sql id="cost_sql">
        <where>
            <if test="userId">
                and d.user_id=#{userId}
            </if>
            <if test="costId">
                and d.cost_id=#{costId}
            </if>
            <if test="keywords != null ">
                and (
                 d.cost_context like #{keywordsLike}
                or d.tag like #{keywordsLike}
                )
            </if>
        </where>
    </sql>
</mapper>